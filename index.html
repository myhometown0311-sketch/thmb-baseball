<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Thumb Baseball - Final Swing Fix</title>
  <style>
    body { margin: 0; padding: 0; overflow: hidden; background-color: #000; font-family: sans-serif; }
    canvas { display: block; position: absolute; top: 0; left: 0; width: 100% !important; height: 100% !important; }
    #loading {
      position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
      color: white; font-size: 20px; text-align: center; text-shadow: 2px 2px 4px #000; pointer-events: none;
      z-index: 10;
      background: rgba(0, 0, 0, 0.8);
      padding: 20px;
      border-radius: 10px;
      border: 2px solid white;
    }
  </style>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.6.0/p5.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.6.0/addons/p5.sound.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
</head>
<body>
  <div id="loading">
    システム読み込み中...<br><br>
    <span style="color: #ffff00; font-weight: bold; font-size: 24px;">スマホは「横画面」にしてください</span><br><br>
    stadium_bg.pngを配置してください
  </div>

<script>
// --- 変数定義 ---
let videoElement, hands, camera;
let thumbTip = null, indexBase = null, wrist = null;
let handDetected = false;

let gameState = 1; // 1:Step1, 2:Step2, 3:Play, 4:Error, 5:GameOver
let angleClosed = 0, angleOpen = 0, currentAngle = 0;
let currentProgressPercent = 0; 
let fixedWristPosition = null; 
const ALLOWED_MOVEMENT_RADIUS = 100;

let balls = [];
let panels = []; 
let score = 0;
let level = 1; 
let maxLives = 3;
let lives = maxLives;

let message = "", messageTimer = 0, messageColor;
let bgImage, bgLoaded = false;
let hitSoundOsc, hitSoundEnv; 
let audioStarted = false;

let batRangeStart, batRangeEnd; 
let guidePositionX, guidePositionY;
let panelStartX, panelStartY;

function preload() {
  bgImage = loadImage('stadium_bg.png', 
    () => { bgLoaded = true; },
    () => { bgLoaded = false; console.log("画像なし"); }
  );
}

function setup() {
  pixelDensity(1); 
  createCanvas(windowWidth, windowHeight);
  videoElement = createCapture(VIDEO);
  videoElement.size(width, height);
  videoElement.hide();

  hitSoundEnv = new p5.Envelope();
  hitSoundEnv.setADSR(0.001, 0.1, 0.2, 0.5); 
  hitSoundEnv.setRange(0.8, 0); 
  hitSoundOsc = new p5.Oscillator('triangle'); 
  hitSoundOsc.amp(hitSoundEnv);
  hitSoundOsc.freq(800); 

  updateLayout();
  initPanels();

  hands = new Hands({locateFile: (file) => 'https://cdn.jsdelivr.net/npm/@mediapipe/hands/' + file});
  hands.setOptions({maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5});
  hands.onResults(onResults);

  camera = new Camera(videoElement.elt, {
    onFrame: async () => { await hands.send({image: videoElement.elt}); },
    width: 1280, height: 720
  });
  camera.start();
}

function windowResized() {
  resizeCanvas(windowWidth, windowHeight);
  updateLayout();
  let oldPanels = panels;
  initPanels();
  if (oldPanels.length === panels.length) {
    for(let i=0; i<panels.length; i++) {
      panels[i].active = oldPanels[i].active;
    }
  }
}

function updateLayout() {
  // バットの可動域設定
  batRangeStart = width * 0.85; // 右側 (閉じたとき)
  batRangeEnd = width * 0.55;   // 左側 (開いたとき)
  guidePositionX = width * 0.85;
  guidePositionY = height / 2 + 100;
}

function initPanels() {
  panels = [];
  let cols = 3; 
  let rows = 3;
  let shrinkRate = constrain(1.0 - (level - 1) * 0.1, 0.5, 1.0);
  let basePanelW = width * 0.06;
  let basePanelH = height * 0.10;
  let panelW = basePanelW * shrinkRate;
  let panelH = basePanelH * shrinkRate;
  let panelGap = 15 + (1 - shrinkRate) * 20;

  panelStartX = width * 0.02; 
  let totalH = rows * panelH + (rows - 1) * panelGap;
  let panelStartY = height - totalH - height * 0.05; 

  for (let r = 0; r < rows; r++) {
    for (let c = 0; c < cols; c++) {
      let num = r * 3 + c + 1;
      panels.push({
        col: c, row: r, 
        x: panelStartX + c * (panelW + panelGap),
        y: panelStartY + r * (panelH + panelGap),
        w: panelW, h: panelH,
        centerX: panelStartX + c * (panelW + panelGap) + panelW/2,
