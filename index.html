<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Number Shot</title>
<style>
  /* --- åŸºæœ¬è¨­å®š --- */
  body {
    margin: 0; padding: 0; overflow: hidden;
    background-color: #000; font-family: "Hiragino Kaku Gothic ProN", sans-serif;
    color: white; touch-action: none;
  }

  /* æ˜ åƒ (èƒŒé¢) */
  #input_video {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    object-fit: cover; z-index: 0; transform: scaleX(-1);
  }

  /* ã‚²ãƒ¼ãƒ æç”» (å‰é¢) */
  canvas {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 10;
  }

  /* UIãƒ¬ã‚¤ãƒ¤ãƒ¼ */
  #ui-layer {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    z-index: 100; pointer-events: none;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
  }

  /* ç”»é¢ãƒ‘ãƒãƒ«å…±é€š */
  .screen {
    background: rgba(0, 0, 0, 0.95);
    border: 2px solid #ffcc00; border-radius: 16px;
    padding: 20px; text-align: center; width: 90%; max-width: 420px;
    pointer-events: auto; display: none;
    box-shadow: 0 10px 40px rgba(0,0,0,0.8);
    max-height: 90vh; overflow-y: auto;
  }
  .screen.active { display: block; }

  h1 { color: #ffeb3b; margin: 0 0 10px 0; font-size: 28px; font-weight: 800; letter-spacing: 1px; }
  h2 { color: #00e5ff; margin: 0 0 10px 0; font-size: 18px; }
  p { font-size: 14px; color: #ccc; margin-bottom: 15px; line-height: 1.5; }

  /* éŠã³æ–¹èª¬æ˜ã‚¨ãƒªã‚¢ (ä¿®æ­£ç®‡æ‰€) */
  .instructions {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 8px; padding: 15px; margin-bottom: 15px;
    text-align: left; font-size: 13px; line-height: 1.7; color: #eee;
  }
  .step-num { 
    display: inline-block; width: 20px; height: 20px; line-height: 20px;
    background: #ffeb3b; color: #000; border-radius: 50%; 
    text-align: center; font-weight: bold; margin-right: 8px; font-size: 12px;
  }

  /* ãƒ©ãƒ³ã‚­ãƒ³ã‚°è¡¨ç¤ºã‚¨ãƒªã‚¢ */
  #ranking-container {
    background: rgba(0, 0, 0, 0.5);
    border: 1px solid #555; border-radius: 8px; padding: 10px;
    margin-bottom: 15px; text-align: left;
  }
  .rank-title { font-size: 14px; color: #ffeb3b; border-bottom: 1px solid #555; margin-bottom: 5px; padding-bottom: 3px; }
  .rank-list { list-style: none; padding: 0; margin: 0; font-size: 14px; }
  .rank-item { display: flex; justify-content: space-between; padding: 3px 0; border-bottom: 1px dashed #333; }
  .rank-item:last-child { border-bottom: none; }
  .rank-rank { width: 30px; font-weight: bold; color: #aaa; }
  .rank-score { color: #fff; font-weight: bold; }
  .rank-item:nth-child(1) .rank-rank { color: #ffd700; }
  .rank-item:nth-child(2) .rank-rank { color: #c0c0c0; }
  .rank-item:nth-child(3) .rank-rank { color: #c47135; }

  .btn {
    width: 100%; padding: 16px; font-size: 18px; font-weight: bold;
    background: linear-gradient(135deg, #ffeb3b, #fbc02d);
    color: #000; border: none; border-radius: 50px;
    margin-top: 5px; cursor: pointer;
    box-shadow: 0 4px 10px rgba(255, 235, 59, 0.3);
  }
  .btn:active { transform: scale(0.96); }

  /* HUD */
  #hud-top {
    position: fixed; top: 15px; left: 15px; z-index: 50;
    display: none; text-shadow: 0 2px 4px rgba(0,0,0,0.8);
  }
  #lives-display { font-size: 24px; margin-bottom: 5px; }
  #score-display { font-size: 20px; font-weight: bold; color: #fff; }
  #combo-display { font-size: 16px; color: #00ff00; margin-top: 2px; font-weight: bold; }
  #level-display { font-size: 18px; color: #ffeb3b; margin-top: 2px; }

  #hud-rom { 
    position: fixed; top: 15px; right: 15px; font-size: 16px; font-weight: bold;
    color: cyan; z-index: 50; display: none; 
    background:rgba(0,0,0,0.7); padding:8px 15px; border-radius:8px; 
    border:1px solid cyan;
  }

  #praise-overlay {
    position: fixed; top: 40%; left: 50%; transform: translate(-50%, -50%);
    z-index: 200; pointer-events: none;
    font-size: 32px; font-weight: bold; color: #fff;
    text-shadow: 0 0 10px #ff00de, 0 0 20px #ff00de;
    text-align: center; white-space: nowrap;
    opacity: 0; transition: opacity 0.5s, transform 0.5s;
  }
  #praise-overlay.show { opacity: 1; transform: translate(-50%, -50%) scale(1.2); }

  #swing-indicator {
    position: fixed; top: 60px; right: 15px; width: 15px; height: 15px;
    border-radius: 50%; background: #333; border: 2px solid #555;
    z-index: 50; display: none;
  }
  #swing-indicator.active { background: #00ff00; box-shadow: 0 0 10px #00ff00; border-color: #fff; }

</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.6.0/p5.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
</head>
<body>

<video id="input_video" playsinline webkit-playsinline muted autoplay></video>

<div id="hud-top">
  <div id="lives-display">â¤ï¸â¤ï¸â¤ï¸</div>
  <div id="score-display">Score: 0</div>
  <div id="combo-display">0 Combo</div>
  <div id="level-display">Lv. 1</div>
</div>

<div id="hud-rom">0Â°</div>
<div id="swing-indicator"></div>
<div id="praise-overlay">Good Job!</div>

<div id="ui-layer">
  <div id="screen-menu" class="screen active">
    <h1>Number Shot</h1>
    
    <div id="ranking-container">
      <div class="rank-title">ğŸ†ï¸ TOP 5 SCORE</div>
      <ul id="ranking-list" class="rank-list">
        <li class="rank-item"><span style="color:#aaa;">èª­ã¿è¾¼ã¿ä¸­...</span></li>
      </ul>
    </div>

    <div class="instructions">
      <span class="step-num">1</span> ã‚±ãƒ¼ã‚¿ã‚¤ã‚’ç½®ã<br>
      <span class="step-num">2</span> æŒã‚’ã‚«ãƒ¡ãƒ©ã«å‘ã‘ã¦ã‚°ãƒ¼âœŠï¸ã‚’æº–å‚™<br>
      <span class="step-num">3</span> è¦ªæŒ‡ã ã‘å¤–è»¢ã™ã‚‹<br>
      <span class="step-num">4</span> å¯å‹•åŸŸã‚’æ¸¬å®šã™ã‚‹<br>
      <span class="step-num">5</span> ãƒœãƒ¼ãƒ«ã«åˆã‚ã›ã¦è¦ªæŒ‡ã‚’å¤–è»¢ï¼<br>
      <span class="step-num">6</span> æ‰“çƒãŒé£›ã‚“ã§ã„ãã®ã‚’ç¢ºèª
    </div>

    <button class="btn" onclick="initSystem('right')">å³æ‰‹ã§ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
    <button class="btn" onclick="initSystem('left')">å·¦æ‰‹ã§ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
  </div>

  <div id="screen-calib" class="screen">
    <h2 id="calib-title">æ¸¬å®šï¼šé–‰ã˜ã‚‹</h2>
    <p id="calib-msg">è¦ªæŒ‡ã‚’é–‰ã˜ã¦ï¼ˆã‚°ãƒ¼ï¼‰<br>ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„</p>
    <div id="calib-val" style="font-size:40px; color:cyan; margin:20px; font-family:monospace;">0Â°</div>
    <button class="btn" onclick="nextCalib()">è¨˜éŒ²</button>
  </div>

  <div id="screen-result" class="screen">
    <h1 style="color:#ff5555;">Game Over</h1>
    <p id="final-score" style="font-size:24px; font-weight:bold; margin-bottom:5px;">Score: 0</p>
    <p id="final-level" style="color:#ffeb3b; margin-bottom:10px;">åˆ°é”ãƒ¬ãƒ™ãƒ«: 1</p>
    
    <div id="new-record-msg" style="color:#00ff00; font-weight:bold; font-size:18px; margin-bottom:15px; display:none;">
      ğŸ‰ ãƒ©ãƒ³ã‚¯ã‚¤ãƒ³ï¼ ğŸ‰
    </div>

    <button class="btn" onclick="location.reload()">ã‚¿ã‚¤ãƒˆãƒ«ã¸æˆ»ã‚‹</button>
  </div>
</div>

<script>
// --- ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•° ---
const videoElem = document.getElementById('input_video');
let hands;
let isRightHand = true;
let appState = 0; // 0:Menu, 1:Calib, 2:Game

// æ‰‹ã®ãƒ‡ãƒ¼ã‚¿
let landmarks = null;
let thumbAngle = 0; 
let angleClose = 0; 
let angleOpen = 0;

// ã‚²ãƒ¼ãƒ ãƒ‡ãƒ¼ã‚¿
let balls = [];
let panels = [];
let score = 0;
let lives = 3;
let level = 1;
let combo = 0;
let bonusGenerated = false;

// ã‚¹ã‚¤ãƒ³ã‚°åˆ¶å¾¡
let batSwing = 0;     
let prevBatSwing = 0; 
let frameCountVal = 0;
let swingActiveTimer = 0;

// éŸ³å£°
let audioCtx = null;

// ãƒ©ãƒ³ã‚­ãƒ³ã‚°ã‚­ãƒ¼
const RANKING_KEY = 'number_shot_ranking';

// è¤’ã‚è¨€è‘‰
const praiseMessages = [
  "ãƒŠã‚¤ã‚¹è¦ªæŒ‡ï¼", "ç´ æ™´ã‚‰ã—ã„å‹•ãï¼", "çŸ­æ¯æŒ‡ä¼¸ç­‹ãŒå–œã‚“ã§ã¾ã™ï¼", 
  "ãã®èª¿å­ï¼", "ãƒªãƒãƒ“ãƒªã®é”äººï¼", "å®Œç’§ãªã‚¿ã‚¤ãƒŸãƒ³ã‚°ï¼", 
  "ç¾ã—ã„å¤–è»¢é‹å‹•ï¼", "ç¥æ¥­ã§ã™ï¼", "ã‚¢ãƒ¡ãƒ¼ã‚¸ãƒ³ã‚°ï¼"
];
let nextPraiseScore = 1000;

// --- èµ·å‹•å‡¦ç† ---
window.onload = function() {
  loadAndShowRanking();
};

// --- ã‚ªãƒ¼ãƒ‡ã‚£ã‚ª ---
function initAudio() {
  if (!audioCtx) {
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    if (AudioContext) audioCtx = new AudioContext();
  }
  if (audioCtx && audioCtx.state === 'suspended') audioCtx.resume();
}

function playSound(type) {
  if (!audioCtx) return;
  const t = audioCtx.currentTime;
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  osc.connect(gain);
  gain.connect(audioCtx.destination);

  if (type === 'hit') {
    osc.type = 'square';
    osc.frequency.setValueAtTime(600, t);
    osc.frequency.exponentialRampToValueAtTime(1200, t + 0.1);
    gain.gain.setValueAtTime(0.1, t);
    gain.gain.exponentialRampToValueAtTime(0.01, t + 0.3);
    osc.start(t); osc.stop(t + 0.3);
  } else if (type === 'break') {
    osc.type = 'sawtooth';
    osc.frequency.setValueAtTime(100, t);
    osc.frequency.linearRampToValueAtTime(50, t + 0.2);
    gain.gain.setValueAtTime(0.2, t);
    gain.gain.linearRampToValueAtTime(0.01, t + 0.4);
    osc.start(t); osc.stop(t + 0.4);
  } else if (type === 'levelup') {
    playTone(880, t, 0.1); playTone(1108, t+0.1, 0.1); playTone(1320, t+0.2, 0.2); playTone(1760, t+0.3, 0.4);
  } else if (type === 'gameover') {
    playTone(300, t, 0.3); playTone(250, t+0.3, 0.6);
  }
}

function playTone(freq, st, dur) {
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  osc.connect(gain); gain.connect(audioCtx.destination);
  osc.type = 'triangle';
  osc.frequency.setValueAtTime(freq, st);
  gain.gain.setValueAtTime(0.1, st);
  gain.gain.linearRampToValueAtTime(0, st + dur);
  osc.start(st); osc.stop(st + dur);
}

// --- ãƒ©ãƒ³ã‚­ãƒ³ã‚° ---
function loadAndShowRanking() {
  let data = localStorage.getItem(RANKING_KEY);
  let ranking = data ? JSON.parse(data) : [];
  const list = document.getElementById('ranking-list');
  list.innerHTML = "";
  if (ranking.length === 0) {
    list.innerHTML = '<li class="rank-item" style="justify-content:center; color:#aaa;">è¨˜éŒ²ãªã—</li>';
    return;
  }
  ranking.forEach((r, index) => {
    let li = document.createElement('li');
    li.className = 'rank-item';
    li.innerHTML = `<span class="rank-rank">${index + 1}.</span><span class="rank-score">${r.score} pt</span>`;
    list.appendChild(li);
  });
}

function saveScore(newScore) {
  let data = localStorage.getItem(RANKING_KEY);
  let ranking = data ? JSON.parse(data) : [];
  ranking.push({ score: newScore, date: new Date().toISOString() });
  ranking.sort((a, b) => b.score - a.score);
  ranking = ranking.slice(0, 5);
  localStorage.setItem(RANKING_KEY, JSON.stringify(ranking));
  return ranking.some(r => r.score === newScore);
}

// --- åˆæœŸåŒ– ---
async function initSystem(hand) {
  isRightHand = (hand === 'right');
  initAudio(); 

  if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
    alert("httpsæ¥ç¶šãŒå¿…è¦ã§ã™ã€‚");
    return;
  }

  document.querySelector('#screen-menu .btn').innerText = "èµ·å‹•ä¸­...";

  try {
    const stream = await navigator.mediaDevices.getUserMedia({
      audio: false,
      video: { facingMode: 'user', width: { ideal: 640 }, height: { ideal: 480 } }
    });
    videoElem.srcObject = stream;
    videoElem.onloadedmetadata = () => {
      videoElem.play();
      initAI();
    };
  } catch (err) {
    alert("ã‚«ãƒ¡ãƒ©ã‚¨ãƒ©ãƒ¼: " + err.name);
  }
}

function initAI() {
  hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
  hands.setOptions({
    maxNumHands: 1, modelComplexity: 0, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5
  });
  hands.onResults(onResults);
  processVideo();
  
  appState = 1;
  switchScreen('screen-calib');
  setupCalib('close');
}

async function processVideo() {
  if (videoElem.videoWidth > 0) await hands.send({image: videoElem});
  requestAnimationFrame(processVideo);
}

function onResults(results) {
  if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
    landmarks = results.multiHandLandmarks[0];
    calcHand();
  } else {
    landmarks = null;
  }
}

function calcHand() {
  if(!landmarks) return;
  let w = width; let h = height;
  let p0 = {x:(1-landmarks[0].x)*w, y:landmarks[0].y*h};
  let p5 = {x:(1-landmarks[5].x)*w, y:landmarks[5].y*h};
  let p4 = {x:(1-landmarks[4].x)*w, y:landmarks[4].y*h};

  let v1 = {x: p5.x - p0.x, y: p5.y - p0.y};
  let v2 = {x: p4.x - p0.x, y: p4.y - p0.y};
  let dot = v1.x * v2.x + v1.y * v2.y;
  let mag1 = Math.sqrt(v1.x*v1.x + v1.y*v1.y);
  let mag2 = Math.sqrt(v2.x*v2.x + v2.y*v2.y);
  if (mag1 * mag2 === 0) return; 
  let cosTheta = Math.max(-1, Math.min(1, dot / (mag1 * mag2)));
  let deg = Math.floor(Math.acos(cosTheta) * (180 / Math.PI));

  thumbAngle = deg;
  if(appState===1) document.getElementById('calib-val').innerText = thumbAngle + "Â°";
  document.getElementById('hud-rom').innerText = thumbAngle + "Â°";
}

// --- p5.js ---
function setup() {
  let cvs = createCanvas(windowWidth, windowHeight);
  cvs.style('pointer-events', 'none');
  clear();
}

function draw() {
  clear();
  if(appState === 2) runGame();
  if(landmarks) drawSkeleton();
}

function drawSkeleton() {
  let w = width; let h = height;
  let p0 = {x:(1-landmarks[0].x)*w, y:landmarks[0].y*h};
  let p5 = {x:(1-landmarks[5].x)*w, y:landmarks[5].y*h};
  let p4 = {x:(1-landmarks[4].x)*w, y:landmarks[4].y*h};
  stroke(100, 200, 255, 150); strokeWeight(4); line(p0.x, p0.y, p5.x, p5.y); 
  stroke(255, 100, 100, 200); line(p0.x, p0.y, p4.x, p4.y); 
  fill(255, 0, 0); noStroke(); circle(p4.x, p4.y, 15);
}

// --- ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ ---
function setupCalib(mode) {
  const t = document.getElementById('calib-title');
  const m = document.getElementById('calib-msg');
  const b = document.querySelector('#screen-calib .btn');
  if(mode === 'close') {
    t.innerText = "æ¸¬å®šï¼šé–‰ã˜ã‚‹";
    m.innerHTML = "è¦ªæŒ‡ã‚’é–‰ã˜ã¦ï¼ˆã‚°ãƒ¼ï¼‰<br>ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„";
    b.innerText = "è¨˜éŒ²";
    angleClose = 0; angleOpen = 0;
  } else {
    t.innerText = "æ¸¬å®šï¼šé–‹ã";
    m.innerHTML = "è¦ªæŒ‡ã‚’æœ€å¤§ã¾ã§é–‹ã„ã¦<br>ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„";
    b.innerText = "ã‚²ãƒ¼ãƒ é–‹å§‹";
  }
}

function nextCalib() {
  const t = document.getElementById('calib-title').innerText;
  if(t.includes("é–‰ã˜ã‚‹")) {
    angleClose = thumbAngle;
    setupCalib('open');
  } else {
    angleOpen = thumbAngle;
    if(Math.abs(angleOpen - angleClose) < 5) {
      alert("å‹•ããŒå°ã•ã™ãã¾ã™ã€‚");
      setupCalib('close');
      return;
    }
    startGame();
  }
}

// --- ã‚²ãƒ¼ãƒ ãƒ­ã‚¸ãƒƒã‚¯ ---
function startGame() {
  appState = 2;
  switchScreen(null);
  document.getElementById('hud-top').style.display = 'block';
  document.getElementById('hud-rom').style.display = 'block';
  document.getElementById('swing-indicator').style.display = 'block';
  score = 0; lives = 3; level = 1; combo = 0;
  balls = []; panels = []; bonusGenerated = false;
  nextPraiseScore = 1000;
  initPanels();
  updateHUD();
}

function initPanels() {
  panels = [];
  let pw = width*0.12; let ph = height*0.08;
  let sx = isRightHand ? width*0.1 : width*0.55;
  for(let r=0; r<3; r++){
    for(let c=0; c<3; c++){
      let id = (r*3)+c+1;
      let y = height*0.55 - (r*(ph+10)); 
      let x = sx + c*(pw+5);
      panels.push({
        id:id, x:x, y:y, w:pw, h:ph, 
        isHit:false, isHeart:false,
        vx:0, vy:0, rot:0, vrot:0, alpha:255
      });
    }
  }
}

function triggerBonus() {
  if (bonusGenerated) return;
  bonusGenerated = true;
  showPraise("BONUS CHANCE!");
  let activePanels = panels.filter(p => !p.isHit);
  if (activePanels.length === 0) { initPanels(); activePanels = panels; }
  let lucky = activePanels[Math.floor(random(activePanels.length))];
  lucky.isHeart = true;
}

function runGame() {
  frameCountVal++;
  let ratio = map(thumbAngle, angleClose, angleOpen, 0, 1);
  prevBatSwing = batSwing;
  batSwing = constrain(ratio, 0, 1);
  let swingTrigger = (prevBatSwing < 0.5 && batSwing >= 0.5);
  
  if(swingTrigger) {
    swingActiveTimer = 15;
    const ind = document.getElementById('swing-indicator');
    ind.classList.add('active');
    setTimeout(()=>ind.classList.remove('active'), 250);
  }
  if(swingActiveTimer > 0) swingActiveTimer--;
  let isBatActive = (swingActiveTimer > 0);

  drawGauge();

  let calcLevel = Math.floor(score / 500) + 1;
  if (calcLevel > level) {
    level = calcLevel;
    updateHUD();
    showPraise(`LEVEL UP! Lv.${level}`);
    playSound('levelup');
  }

  if (level >= 10 && !bonusGenerated) triggerBonus();

  if(balls.length === 0 && frameCountVal % 60 === 0) {
    let sx = isRightHand ? 0 : width;
    let tx = isRightHand ? width*0.8 : width*0.2;
    let pitchType = 'straight';
    if (level >= 9) {
        let r = random();
        if (r < 0.35) pitchType = 'curve'; else if (r < 0.6) pitchType = 'changeup';
    }
    let speedBase = 70; 
    let travelFrames = Math.max(15, speedBase - (level * 3));
    balls.push({
      x:sx, y:height*0.6, 
      vx:(tx-sx)/travelFrames, 
      vy: (pitchType==='curve' ? (isRightHand ? -3 : 3) : 0), 
      ay: (pitchType==='curve' ? (isRightHand ? 0.1 : -0.1) : 0), 
      type: pitchType, isDecelerated: false, active:true, hit:false
    });
  }

  let hitZone = isRightHand ? width*0.8 : width*0.2;
  for(let i=balls.length-1; i>=0; i--){
    let b = balls[i];
    b.x += b.vx; b.y += b.vy;
    
    if (!b.hit) {
        b.vy += b.ay || 0; 
        if (b.type === 'changeup' && !b.isDecelerated) {
            let isPassedCenter = isRightHand ? (b.x > width * 0.45) : (b.x < width * 0.55);
            if (isPassedCenter) {
                b.vx *= 0.5; let minSpeed = 3.0; 
                if(Math.abs(b.vx) < minSpeed) b.vx = (b.vx > 0) ? minSpeed : -minSpeed;
                b.vy += 2.0; b.isDecelerated = true;
            }
        }
    }
    
    fill(255); stroke(0); circle(b.x, b.y, 20);
    
    let inZone = abs(b.x - hitZone) < 70;
    if(!b.hit && b.active && inZone && isBatActive) {
      b.hit = true;
      playSound('hit'); 
      let aim = 0;
      if(batSwing > 0.75) aim = 2; else if(batSwing > 0.5) aim = 1;
      let targets = panels.filter(p => !p.isHit && Math.floor((p.id-1)/3) === aim);
      if(targets.length === 0) targets = panels.filter(p => !p.isHit);
      let t = targets.length > 0 ? targets[floor(random(targets.length))] : null;
      let tx = t ? t.x+t.w/2 : (isRightHand?0:width);
      let ty = t ? t.y+t.h/2 : 0;
      let dx = tx-b.x; let dy = ty-b.y; let len = sqrt(dx*dx+dy*dy);
      let ballSpeed = 20 + level;
      b.vx = (dx/len)*ballSpeed; b.vy = (dy/len)*ballSpeed;
      combo++;
      if (combo > 0 && combo % 10 === 0) showPraise("ã‚¤ã‚¤ã˜ã‚ƒã‚“ï¼ğŸ‘ï¸");
      updateHUD();
    }
    
    if(b.hit && b.active) {
      for(let p of panels) {
        if(!p.isHit && b.x>p.x && b.x<p.x+p.w && b.y>p.y && b.y<p.y+p.h) {
          p.isHit = true; 
          p.vx = random(-5, 5); p.vy = random(-10, -5); p.vrot = random(-0.2, 0.2);
          b.active = false; 
          playSound('break'); 
          if (p.isHeart) {
            lives = Math.min(3, lives + 1); showPraise("LIFE UP! â¤ï¸");
          } else {
            score+=100;
          }
          checkScorePraise(); updateHUD(); break;
        }
      }
    }
    
    if(b.x<-100 || b.x>width+100 || b.y<-100 || b.y>height+100) {
      if(!b.hit && b.active) {
        lives--; combo = 0; updateHUD();
        if(lives<=0) {
          playSound('gameover'); 
          gameOver();
        }
      }
      balls.splice(i,1);
    }
  }

  let activeCount = 0;
  for(let p of panels) {
    if (!p.isHit) {
      activeCount++;
      if (p.isHeart) { fill(255, 100, 150, 200); stroke(255); } else { fill(0,200,0,150); stroke(255); }
      strokeWeight(2); rect(p.x, p.y, p.w, p.h);
      fill(255); noStroke(); textAlign(CENTER,CENTER); textSize(24);
      if (p.isHeart) text("â¤ï¸", p.x+p.w/2, p.y+p.h/2); else text(p.id, p.x+p.w/2, p.y+p.h/2);
    } else {
      if (p.alpha > 0) {
        p.x += p.vx; p.y += p.vy; p.vy += 0.5; p.rot += p.vrot; p.alpha -= 5;
        push(); translate(p.x + p.w/2, p.y + p.h/2); rotate(p.rot);
        fill(p.isHeart?255:255, p.isHeart?100:0, p.isHeart?150:0, p.alpha);
        stroke(255, p.alpha); rect(-p.w/2, -p.h/2, p.w, p.h);
        pop();
      }
    }
  }

  if(activeCount===0 && panels.length>0) { 
    score+=1000; initPanels(); checkScorePraise(); updateHUD(); 
  }
}

function checkScorePraise() {
  if (score >= nextPraiseScore) {
    let msg = praiseMessages[Math.floor(random(praiseMessages.length))];
    showPraise(msg);
    nextPraiseScore += 1000;
  }
}

function showPraise(text) {
  const el = document.getElementById('praise-overlay');
  el.innerText = text; el.classList.add('show');
  let colors = ["#ff00de", "#00ff00", "#00e5ff", "#ffeb3b", "#ff5252"];
  let c = colors[Math.floor(random(colors.length))];
  el.style.textShadow = `0 0 10px ${c}, 0 0 20px ${c}`;
  setTimeout(() => { el.classList.remove('show'); }, 2000);
}

function drawGauge() {
  let x = isRightHand ? width-30 : 30;
  let y = height/2; let h = 200;
  fill(100, 150); rect(x-5, y-h/2, 10, h);
  let cy = map(batSwing, 0, 1, y+h/2, y-h/2);
  if(swingActiveTimer > 0) fill(255, 255, 0); else fill(0, 255, 0);
  circle(x, cy, 20);
  stroke(255); line(x-10, y-h/6, x+10, y-h/6); line(x-10, y+h/6, x+10, y+h/6);
  stroke(255,0,0); line(x-15, y, x+15, y); 
}

function updateHUD() {
  let s=""; for(let i=0;i<lives;i++) s+="â¤ï¸";
  document.getElementById('lives-display').innerHTML = s;
  document.getElementById('score-display').innerText = "Score: " + score;
  document.getElementById('combo-display').innerText = combo + " Combo!";
  document.getElementById('level-display').innerText = "Lv. " + level;
}

function gameOver() {
  appState = 3;
  let isRankIn = saveScore(score);
  document.getElementById('final-score').innerText = "Score: " + score;
  document.getElementById('final-level').innerText = "åˆ°é”ãƒ¬ãƒ™ãƒ«: " + level;
  document.getElementById('new-record-msg').style.display = isRankIn ? 'block' : 'none';
  switchScreen('screen-result');
}

function switchScreen(id) {
  document.querySelectorAll('.screen').forEach(e=>e.classList.remove('active'));
  if(id) document.getElementById(id).classList.add('active');
}

function windowResized() { resizeCanvas(windowWidth, windowHeight); }
</script>
</body>
</html>
