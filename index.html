<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Thumb Baseball Final</title>
<style>
  body { 
    margin: 0; padding: 0; overflow: hidden; 
    background-color: #000; font-family: sans-serif; 
    touch-action: none;
  }
  canvas { 
    display: block; 
    position: fixed !important; 
    top: 0; left: 0; 
    width: 100vw; height: 100vh;
    z-index: -1 !important; 
    pointer-events: auto; 
  }
  #ui-layer {
    position: fixed !important; 
    top: 0; left: 0;
    width: 100%; height: 100%;
    z-index: 99999 !important; 
    background: rgba(0, 0, 0, 0.85); 
    display: flex; flex-direction: column; 
    justify-content: center; align-items: center;
    color: white; text-align: center;
    pointer-events: auto;
  }
  h1 { color: #ffff00; font-size: 28px; margin-bottom: 10px; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
  p { color: #ccc; margin-bottom: 30px; font-size: 14px; padding: 0 20px; }
  .btn {
    background: #ffcc00; color: #000; font-weight: bold;
    border: 3px solid #fff; border-radius: 50px;
    padding: 16px 40px; font-size: 18px; margin: 12px;
    cursor: pointer; min-width: 220px;
    box-shadow: 0 4px 15px rgba(255, 200, 0, 0.4);
    transition: transform 0.1s;
  }
  .btn:active { transform: scale(0.95); }
  #error-msg {
    color: #ff5555; font-weight: bold; margin-top: 20px; 
    background: rgba(0,0,0,0.9); padding: 15px; border-radius: 8px;
    border: 1px solid #ff5555; display: none; max-width: 90%;
  }
  video { display: none; }
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.6.0/p5.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
</head>
<body>

<div id="ui-layer">
  <h1>Thumb Baseball</h1>
  <p>親指野球ゲーム<br>（画面タップでリセット機能付き）</p>
  
  <div id="buttons">
    <button id="btn-right" class="btn" onclick="tryStart('right')">右手でスタート ✋</button><br>
    <button id="btn-left" class="btn" onclick="tryStart('left')">左手でスタート ✋</button>
  </div>
  
  <div id="loading" style="display:none;">
    <p style="color:#0f0; font-size:18px; font-weight:bold;">
      カメラを起動中...<br>
      <span style="font-size:12px; color:#aaa;">許可ポップアップが出たら「許可」を押してください</span>
    </p>
  </div>

  <div id="error-msg"></div>
</div>

<video id="input_video" playsinline webkit-playsinline muted autoplay></video>

<script>
// --- グローバル変数 ---
let videoElement = document.getElementById('input_video');
let hands;
let camera;  // 追加
let isRightHand = true;
let isPlaying = false;
let landmarks = null;

// ゲーム変数（省略、変更なし）
let handScale = 100;
let smoothedDist = 0;
let batProgress = 0;
let score = 0;
let balls = [];
let panels = [];
let guidePos = {x:0, y:0};
let message = ""; 
let messageTimer = 0;

// --- 起動処理 ---
async function tryStart(hand) {
  isRightHand = (hand === 'right');
  document.getElementById('buttons').style.display = 'none';
  document.getElementById('loading').style.display = 'block';
  document.getElementById('error-msg').style.display = 'none';

  if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
    showError("【エラー】HTTPSで接続されていません。");
    return;
  }

  try {
    const stream = await navigator.mediaDevices.getUserMedia({
      audio: false,
      video: { facingMode: 'user', width: { ideal: 640 }, height: { ideal: 480 } }
    });
    videoElement.srcObject = stream;
    await videoElement.play();
    loadAI();
  } catch (err) {
    showError("【カメラエラー】<br>カメラへのアクセスが拒否されました。<br>(" + err.name + ")");
  }
}

function loadAI() {
  try {
    hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
    hands.setOptions({
      maxNumHands: 1,
      modelComplexity: 0,
      minDetectionConfidence: 0.5,
      minTrackingConfidence: 0.5
    });
    hands.onResults(onResults);

    camera = new Camera(videoElement, {
      onFrame: async () => {
        await hands.send({image: videoElement});
      },
      width: 640,
      height: 480
    });
    camera.start();

    document.getElementById('ui-layer').style.display = 'none';
    isPlaying = true;
    setupGame();
  } catch(e) {
    showError("AI読み込みエラー: " + e);
  }
}

function showError(msg) {
  document.getElementById('buttons').style.display = 'block';
  document.getElementById('loading').style.display = 'none';
  const errDiv = document.getElementById('error-msg');
  errDiv.innerHTML = msg;
  errDiv.style.display = 'block';
}

function onResults(results) {
  if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
    landmarks = results.multiHandLandmarks[0];
  } else {
    landmarks = null;
  }
}

// --- p5.js ---
function setup() {
  canvasElem = createCanvas(windowWidth, windowHeight);
  canvasElem.style('position', 'fixed');
  canvasElem.style('top', '0');
  canvasElem.style('left', '0');
  canvasElem.style('z-index', '-1');
  frameRate(30);
  initPanels();
}

function draw() {
  background(34, 139, 34);

  if (!isPlaying) return;

  // カメラ映像はCameraが裏で処理、手の検出結果だけ使う

  if (landmarks) {
    // 手の処理（変更なし）
    let idxBase = transform(landmarks[5]);
    let thumbTip = transform(landmarks[4]);
    let wrist = transform(landmarks[0]);

    stroke(0, 255, 255); strokeWeight(3);
    line(idxBase.x, idxBase.y, wrist.x, wrist.y);
    stroke(255, 0, 0); strokeWeight(5);
    line(idxBase.x, idxBase.y, thumbTip.x, thumbTip.y);

    let size = dist(idxBase.x, idxBase.y, wrist.x, wrist.y);
    handScale = lerp(handScale, size, 0.1);
    let d = dist(idxBase.x, idxBase.y, thumbTip.x, thumbTip.y);
    smoothedDist = lerp(smoothedDist, d, 0.5);

    let val = map(smoothedDist, handScale*0.3, handScale*0.9, 0, 1);
    batProgress = constrain(val, 0, 1);

    drawGuide(true);
  } else {
    drawGuide(false);
  }

  runGameLogic();
  drawHUD();
}

// 以降の関数（transform, setupGame, ... drawHUDなど）はすべて変更なし

function touchMoved() { return false; }
function touchStarted() { return false; }

function windowResized(){ resizeCanvas(windowWidth,windowHeight); initPanels(); }
</script>
</body>
</html>
