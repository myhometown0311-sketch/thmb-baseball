<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
  <title>Thumb Baseball - Physics Edition</title>
  <style>
    body { margin: 0; padding: 0; overflow: hidden; background-color: #222; font-family: sans-serif; touch-action: manipulation; }
    
    canvas { display: block; position: absolute; top: 0; left: 0; width: 100% !important; height: 100% !important; z-index: 0; }
    
    /* 操作盤 */
    #overlay {
      position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.95);
      display: flex; flex-direction: row; 
      justify-content: center; align-items: center;
      z-index: 1000; color: white; text-align: center;
      pointer-events: auto;
    }

    #left-panel { width: 45%; padding: 10px; display: flex; justify-content: center; }
    #instruction {
      background: rgba(255, 255, 255, 0.15);
      border: 1px solid #777;
      border-radius: 8px; padding: 15px;
      font-size: 14px; line-height: 1.8; color: white;
      text-align: left; width: 100%; max-width: 400px;
    }

    #right-panel { width: 45%; padding: 10px; display: flex; flex-direction: column; align-items: center; }
    
    h1 { margin: 0 0 20px 0; font-size: 28px; color: #ffff00; text-shadow: 0 0 10px rgba(255,255,0,0.5); }

    .btn-container { display: flex; flex-direction: column; gap: 20px; width: 100%; max-width: 300px; }

    .hand-btn {
      padding: 20px 0; font-size: 22px; font-weight: bold;
      color: #000; background: #ffff00; border: 4px solid #fff; border-radius: 15px; 
      cursor: pointer; width: 100%; 
      box-shadow: 0 5px 15px rgba(255, 255, 0, 0.4);
      transition: transform 0.1s, background 0.1s;
    }
    .hand-btn:active { background: #ffaa00; transform: scale(0.95); }
    
    #statusLog {
      margin-top: 20px; color: #00ff00; font-weight: bold; 
      font-size: 14px; background: #222; border: 1px solid #555;
      padding: 10px; border-radius: 5px; width: 100%; max-width: 300px;
      min-height: 40px; word-wrap: break-word; text-align: left;
    }

    #rawVideo { display: none; }
  </style>
  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.6.0/p5.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
</head>
<body>

  <video id="rawVideo" playsinline webkit-playsinline muted autoplay></video>
  
  <div id="overlay">
    <div id="left-panel">
      <div id="instruction">
        <strong>【設定手順】</strong><br>
        1. プレイする手を選んでください。<br>
        2. <strong>親指を閉じて</strong>タップ（構え）。<br>
        3. <strong>親指を開いて</strong>タップ（スイング）。<br>
        ➜ <strong>ゲームスタート！</strong><br>
        <hr style="border:0; border-top:1px solid #555; margin:10px 0;">
        <small><strong>物理演算モード搭載</strong><br>手首のスナップと慣性が反映されます。</small>
      </div>
    </div>

    <div id="right-panel">
      <h1>Thumb Baseball<br><span style="font-size:0.6em">Physics Edition</span></h1>
      <div id="btn-group" class="btn-container">
        <button id="btnRight" class="hand-btn" onclick="handleClick('right')">右手でプレイ ✋</button>
        <button id="btnLeft" class="hand-btn" onclick="handleClick('left')">左手でプレイ ✋</button>
      </div>
      <div id="statusLog">準備完了。ボタンを押してください。</div>
    </div>
  </div>

<script>
window.onerror = function(msg, url, line) {
  const el = document.getElementById('statusLog');
  if(el) { el.innerHTML = "⚠️ エラー:<br>" + msg; el.style.color = "#ff5555"; }
};

let rawVideo = document.getElementById('rawVideo');
let hands = null;
let camera = null;
let thumbTip = null, indexBase = null, wrist = null;
let handDetected = false;
let isGameStarted = false;
let isRightHand = true; 

let gameState = 1; 
let angleClosed = 0, angleOpen = 0;
let smoothedAngle = 0; 
let fixedWristPosition = null; 

// --- 物理演算用変数 ---
let batCurrentProgress = 0; // バットの現在位置 (0.0 - 1.0)
let batVelocity = 0;        // バットの速度
// --------------------

let balls = [];
let panels = []; 
let score = 0;
let level = 1; 
let maxLives = 3;
let lives = maxLives;
let combo = 0;

let message = "", messageTimer = 0, messageColor;
let bgImage = null;
let audioCtx = null;

let batOuterX, batInnerX; 
let guidePositionX, guidePositionY;
let panelStartX;

function log(msg) {
  const el = document.getElementById('statusLog');
  if(el) el.innerHTML = msg;
}

function setup() {
  pixelDensity(1);
  let cnv = createCanvas(windowWidth, windowHeight);
  cnv.style('z-index', '-1'); 
  
  loadImage('stadium_bg.png', 
    (img) => { bgImage = img; },
    (err) => { console.log("背景画像なし"); }
  );

  updateLayout();
  initPanels();
  log("準備OK。手を選んでください。");
}

function draw() {
  if (bgImage) {
    let imgAspect = bgImage.width / bgImage.height;
    let canvasAspect = width / height;
    let dw, dh, dx, dy;
    if (canvasAspect > imgAspect) { dw=width; dh=width/imgAspect; dx=0; dy=(height-dh)/2; }
    else { dh=height; dw=height*imgAspect; dy=0; dx=(width-dw)/2; }
    image(bgImage, dx, dy, dw, dh);
  } else {
    background(34, 139, 34);
    noStroke(); fill(0, 100, 0, 50);
    for(let i=0; i<height; i+=40) rect(0, i, width, 20);
  }

  if (!isGameStarted) return;

  if (rawVideo && rawVideo.readyState >= 2) {
    push();
    translate(width, 0); scale(-1, 1); tint(255, 80); 
    drawingContext.drawImage(rawVideo, 0, 0, width, height);
    pop();
  }

  if (handDetected && wrist && thumbTip) {
    stroke(255, 0, 0); strokeWeight(3); 
    line(wrist.x, wrist.y, thumbTip.x, thumbTip.y);
    fill(255,0,0); noStroke(); circle(thumbTip.x, thumbTip.y, 10);
  }

  handleInput();
  drawPanels();
  drawAlwaysGuide();

  if (gameState === 3) {
    playGame();
  } else if (gameState === 4) {
    drawErrorScreen();
  } else if (gameState === 5) {
    drawGameOverScreen();
  } else {
    drawSetupUI();
  }
}

function handleClick(hand) {
  document.getElementById('btn-group').style.display = 'none';
  log("起動中...カメラを許可してください");
  setTimeout(() => { startSequence(hand); }, 100);
}

async function startSequence(hand) {
  isRightHand = (hand === 'right');
  try {
    const AudioContext = window.AudioContext || window.webkitAudioContext;
    if(AudioContext) { audioCtx = new AudioContext(); audioCtx.resume(); }
  } catch(e) {}
  updateLayout();
  initPanels();
  startCamera();
}

function startCamera() {
  const constraints = {
    audio: false,
    video: { facingMode: "user", width: { ideal: 640 }, height: { ideal: 480 } }
  };
  if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
    alert("このブラウザはカメラ非対応です"); return;
  }
  navigator.mediaDevices.getUserMedia(constraints)
    .then(stream => {
      rawVideo.srcObject = stream;
      rawVideo.onloadedmetadata = () => {
        rawVideo.play();
        log("AIエンジン読み込み中...");
        initMediaPipe(); 
      };
    })
    .catch(err => {
      alert("カメラエラー: " + err.message);
      document.getElementById('btn-group').style.display = 'flex';
    });
}

function initMediaPipe() {
  if (typeof Hands === 'undefined') {
    log("AIライブラリ未ロード。リロードしてください。"); return;
  }
  hands = new Hands({locateFile: (file) => 'https://cdn.jsdelivr.net/npm/@mediapipe/hands/' + file});
  hands.setOptions({
    maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.7, minTrackingConfidence: 0.7
  });
  hands.onResults(onResults);
  camera = new Camera(rawVideo, {
    onFrame: async () => { 
      if(rawVideo.videoWidth > 0 && !rawVideo.paused) await hands.send({image: rawVideo}); 
    },
    width: 640, height: 480
  });
  camera.start().then(() => {
    log("完了！ゲーム画面へ...");
    setTimeout(() => {
      document.getElementById('overlay').style.display = 'none';
      isGameStarted = true;
    }, 500);
  });
}

function onResults(results) {
  if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
    handDetected = true;
    const lm = results.multiHandLandmarks[0];
    thumbTip = createVector((1 - lm[4].x) * width, lm[4].y * height);
    indexBase = createVector((1 - lm[5].x) * width, lm[5].y * height);
    wrist = createVector((1 - lm[0].x) * width, lm[0].y * height);
    
    let v1 = p5.Vector.sub(indexBase, wrist);
    let v2 = p5.Vector.sub(thumbTip, wrist);
    let rawAngle = v1.angleBetween(v2);
    
    if (smoothedAngle === 0) smoothedAngle = rawAngle;
    
    // AIのジッター（震え）を軽減するためのフィルタ
    smoothedAngle = lerp(smoothedAngle, rawAngle, 0.4); 
  } else {
    handDetected = false;
  }
}

function handleInput() {
  if (gameState === 5 || gameState === 4) return;
  if (handDetected) {
    if
