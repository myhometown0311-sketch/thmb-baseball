<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
<title>Thumb Baseball Final</title>
<style>
  /* 基本設定：スクロール禁止、黒背景 */
  body { 
    margin: 0; padding: 0; overflow: hidden; 
    background-color: #000; font-family: sans-serif; 
    touch-action: none;
  }
  
  /* キャンバス（ゲーム画面）：強制的に一番後ろへ */
  canvas { 
    display: block; 
    position: fixed !important; 
    top: 0; left: 0; 
    width: 100vw; height: 100vh;
    z-index: -1 !important; /* 最背面 */
    pointer-events: auto; /* タッチ操作は受け付ける */
  }
  
  /* UIレイヤー（操作パネル）：強制的に一番手前へ */
  #ui-layer {
    position: fixed !important; 
    top: 0; left: 0; 
    width: 100%; height: 100%;
    z-index: 99999 !important; /* 最前面 */
    background: rgba(0, 0, 0, 0.85); /* 背景を少し濃く */
    display: flex; flex-direction: column; 
    justify-content: center; align-items: center;
    color: white; text-align: center;
    pointer-events: auto;
  }
  
  h1 { color: #ffff00; font-size: 28px; margin-bottom: 10px; text-shadow: 0 2px 4px rgba(0,0,0,0.5); }
  p { color: #ccc; margin-bottom: 30px; font-size: 14px; padding: 0 20px; }

  .btn {
    background: #ffcc00; color: #000; font-weight: bold;
    border: 3px solid #fff; border-radius: 50px;
    padding: 16px 40px; font-size: 18px; margin: 12px;
    cursor: pointer; min-width: 220px;
    box-shadow: 0 4px 15px rgba(255, 200, 0, 0.4);
    transition: transform 0.1s;
  }
  .btn:active { transform: scale(0.95); }
  
  /* エラー表示 */
  #error-msg {
    color: #ff5555; font-weight: bold; margin-top: 20px; 
    background: rgba(0,0,0,0.9); padding: 15px; border-radius: 8px;
    border: 1px solid #ff5555; display: none; max-width: 90%;
  }

  video { display: none; } /* 映像要素は隠す */
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.6.0/p5.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
</head>
<body>

<div id="ui-layer">
  <h1>Thumb Baseball</h1>
  <p>親指野球ゲーム<br>（画面タップでリセット機能付き）</p>
  
  <div id="buttons">
    <button id="btn-right" class="btn" onclick="tryStart('right')">右手でスタート ✋</button><br>
    <button id="btn-left" class="btn" onclick="tryStart('left')">左手でスタート ✋</button>
  </div>
  
  <div id="loading" style="display:none;">
    <p style="color:#0f0; font-size:18px; font-weight:bold;">
      カメラを起動中...<br>
      <span style="font-size:12px; color:#aaa;">許可ポップアップが出たら「許可」を押してください</span>
    </p>
  </div>

  <div id="error-msg"></div>
</div>

<video id="input_video" playsinline webkit-playsinline muted autoplay></video>

<script>
// --- グローバル変数 ---
let videoElement = document.getElementById('input_video');
let hands;
let isRightHand = true;
let isPlaying = false;
let landmarks = null;
let canvasElem; // キャンバス要素

// ゲーム用変数
let handScale = 100;
let smoothedDist = 0;
let batProgress = 0;
let score = 0;
let balls = [];
let panels = [];
let guidePos = {x:0, y:0};
let message = ""; 
let messageTimer = 0;

// --- 起動処理 ---
async function tryStart(hand) {
  isRightHand = (hand === 'right');
  
  // UI更新
  document.getElementById('buttons').style.display = 'none';
  document.getElementById('loading').style.display = 'block';
  document.getElementById('error-msg').style.display = 'none';

  // HTTPSチェック
  if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
    showError("【エラー】HTTPSで接続されていません。<br>URLが https:// で始まっているか確認してください。");
    return;
  }

  // カメラ起動
  try {
    const stream = await navigator.mediaDevices.getUserMedia({
      audio: false,
      video: { facingMode: 'user', width: { ideal: 640 }, height: { ideal: 480 } }
    });
    videoElement.srcObject = stream;
    await videoElement.play();
    loadAI();
  } catch (err) {
    showError("【カメラエラー】<br>カメラへのアクセスが拒否されました。<br>ブラウザの設定でカメラを許可してください。<br>(" + err.name + ")");
  }
}

function loadAI() {
  try {
    hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
    hands.setOptions({
      maxNumHands: 1,
      modelComplexity: 0, // 軽量設定
      minDetectionConfidence: 0.5,
      minTrackingConfidence: 0.5
    });
    hands.onResults(onResults);
    
    // 準備完了：UIを隠す
    document.getElementById('ui-layer').style.display = 'none';
    isPlaying = true;
    setupGame();
  } catch(e) {
    showError("AI読み込みエラー: " + e);
  }
}

function showError(msg) {
  document.getElementById('buttons').style.display = 'block';
  document.getElementById('loading').style.display = 'none';
  const errDiv = document.getElementById('error-msg');
  errDiv.innerHTML = msg;
  errDiv.style.display = 'block';
}

function onResults(results) {
  if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
    landmarks = results.multiHandLandmarks[0];
  } else {
    landmarks = null;
  }
}

// --- p5.js セットアップ ---
function setup() {
  // キャンバス作成時に明示的にスタイル適用
  canvasElem = createCanvas(windowWidth, windowHeight);
  canvasElem.style('position', 'fixed');
  canvasElem.style('top', '0');
  canvasElem.style('left', '0');
  canvasElem.style('z-index', '-1'); // ★ここが重要：JS側でも最背面指定
  canvasElem.id('game-canvas');
  
  frameRate(30);
  initPanels();
}

function draw() {
  // 背景描画（緑色）
  background(34, 139, 34);
  
  if (!isPlaying) return;

  // カメラ映像描画
  if (videoElement.readyState >= 2) {
    push();
    translate(width, 0); scale(-1, 1);
    
    // 画面いっぱいに表示（Cover）
    let vw = videoElement.videoWidth;
    let vh = videoElement.videoHeight;
    let scaleVal = max(width/vw, height/vh);
    let w = vw * scaleVal;
    let h = vh * scaleVal;
    let x = (width - w) / 2;
    let y = (height - h) / 2;
    
    image(videoElement, x, y, w, h);
    hands.send({image: videoElement});
    pop();
    
    // 画面を少し暗くして視認性アップ
    fill(0, 120); noStroke(); rect(0,0,width,height);
  }

  // ゲームロジック
  if (landmarks) {
    let idxBase = transform(landmarks[5]);
    let thumbTip = transform(landmarks[4]);
    let wrist = transform(landmarks[0]);

    // 骨格表示
    stroke(0, 255, 255); strokeWeight(3);
    line(idxBase.x, idxBase.y, wrist.x, wrist.y);
    stroke(255, 0, 0); strokeWeight(5);
    line(idxBase.x, idxBase.y, thumbTip.x, thumbTip.y);

    // 操作計算
    let size = dist(idxBase.x, idxBase.y, wrist.x, wrist.y);
    handScale = lerp(handScale, size, 0.1);
    let d = dist(idxBase.x, idxBase.y, thumbTip.x, thumbTip.y);
    smoothedDist = lerp(smoothedDist, d, 0.5);

    let val = map(smoothedDist, handScale*0.3, handScale*0.9, 0, 1);
    batProgress = constrain(val, 0, 1);

    drawGuide(true);
  } else {
    drawGuide(false);
  }

  runGameLogic();
  drawHUD();
}

function transform(lm) {
  return { x: (1-lm.x)*width, y: lm.y*height };
}

function setupGame() {
  updateLayout();
  initPanels();
}

function updateLayout() {
  guidePos = isRightHand ? {x: width*0.85, y: height*0.75} : {x: width*0.15, y: height*0.75};
}

function drawGuide(active) {
  noFill(); stroke(active ? '#0f0' : '#f00'); strokeWeight(3);
  circle(guidePos.x, guidePos.y, 70);
  if(!active) {
    noStroke(); fill(255); textAlign(CENTER); textSize(18); textStyle(BOLD);
    text("カメラに手を映してください", width/2, height/2);
    textStyle(NORMAL);
  }
}

function runGameLogic() {
  // バット
  let bx = isRightHand ? width*0.85 : width*0.15;
  let by = height*0.75 - 70;
  push();
  translate(bx, by);
  let ang = isRightHand ? map(batProgress, 0, 1, PI/4, -PI/4) : map(batProgress, 0, 1, -PI/4, PI/4);
  rotate(ang);
  if(batProgress>0.1) { stroke(0); fill(255,200,0); } else { noStroke(); fill(255,50); }
  rect(-12, 0, 24, 140, 10);
  pop();

  // ボール
  if(frameCount%60===0) balls.push(createBall());
  for(let i=balls.length-1; i>=0; i--) {
    let b = balls[i];
    b.x+=b.vx; b.y+=b.vy;
    fill(b.hit?'#ff0':'#fff'); stroke(0); circle(b.x, b.y, 25);

    if(!b.hit && batProgress>0.1) {
      if(dist(b.x,b.y,bx,by)<180 && dist(b.x,b.y,guidePos.x,guidePos.y)<180) {
        b.hit=true;
        let tx = isRightHand ? map(batProgress,0.2,0.8,0,width) : map(batProgress,0.2,0.8,width,0);
        let dy=(panels[0].y+50)-b.y; let dx=tx-b.x;
        let len=sqrt(dx*dx+dy*dy);
        b.vx=(dx/len)*25; b.vy=(dy/len)*25;
        score+=10; showMessage("HIT!");
      }
    }
    if(b.hit) {
      for(let p of panels) {
        if(p.active && b.x>p.x && b.x<p.x+p.w && b.y>p.y && b.y<p.y+p.h) {
          p.active=false; balls.splice(i,1); score+=50; showMessage("BREAK!"); return;
        }
      }
    }
    if(b.y>height+50 || b.y<-50) balls.splice(i,1);
  }
  drawPanels();
}

function createBall() {
  let sx = isRightHand ? width*0.1 : width*0.9;
  let tx = guidePos.x; let ty = guidePos.y-50;
  let dx=tx-sx; let dy=ty-height*0.4; let len=sqrt(dx*dx+dy*dy);
  let spd = 9 + score/500;
  return {x:sx, y:height*0.4, vx:(dx/len)*spd, vy:(dy/len)*spd, hit:false};
}

function initPanels() {
  panels=[];
  let w=width/5; let h=height/12;
  for(let i=0; i<3; i++) for(let j=0; j<3; j++) {
    panels.push({
      x: isRightHand ? 20+j*(w+5) : width-(3*(w+5))+(j*(w+5)),
      y: 50+i*(h+5), w:w, h:h, active:true
    });
  }
}
function drawPanels() {
  if(panels.every(p=>!p.active)) { initPanels(); showMessage("STAGE CLEAR!"); }
  for(let p of panels) if(p.active) { fill(0,255,0,180); stroke(255); rect(p.x,p.y,p.w,p.h,5); }
}

function drawHUD() {
  fill(255); textSize(24); textAlign(LEFT,TOP); text("SCORE: "+score, 20,20);
  if(messageTimer>0) {
    textAlign(CENTER,CENTER); textSize(40); fill(255,255,0); stroke(0); strokeWeight(4);
    text(message, width/2, height/2); messageTimer--;
  }
  // ゲージ
  let gh = map(batProgress,0,1,0,150);
  fill(255,0,0); rect(width-40,height-200,30,150);
  fill(0,255,0); rect(width-40,height-200+(150-gh),30,gh);
}
function showMessage(msg){ message=msg; messageTimer=30; }

function windowResized(){ resizeCanvas(windowWidth,windowHeight); initPanels(); }

// ダブルタップ等でリセットする緊急用
function doubleClicked() {
  // もしUIが消えていて動かない場合、リセット
  if(!isPlaying) return;
  // ここにリセット処理を入れることも可能
}
</script>
</body>
</html>
