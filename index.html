<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Thumb Baseball Safe</title>
<style>
  body { 
    margin: 0; padding: 0; overflow: hidden; 
    background-color: #000; font-family: sans-serif; 
    touch-action: none;
  }
  
  /* ゲーム画面（キャンバス） */
  canvas { position: fixed; top: 0; left: 0; z-index: 1; }
  
  /* 操作パネル（最前面） */
  #ui-layer {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    z-index: 9999; /* 緑画面より手前に表示 */
    background: rgba(0,0,0,0.8);
    display: flex; flex-direction: column; justify-content: center; align-items: center;
    color: white; text-align: center;
  }
  
  h1 { color: #ffff00; font-size: 28px; margin-bottom: 10px; }
  p { color: #ccc; margin-bottom: 30px; }

  .btn {
    background: #ffcc00; color: #000; font-weight: bold;
    border: 3px solid #fff; border-radius: 50px;
    padding: 15px 40px; font-size: 18px; margin: 10px;
    cursor: pointer; min-width: 200px;
  }
  .btn:disabled { background: #555; color: #888; border-color: #555; }
  
  /* エラー表示エリア */
  #error-msg {
    color: #ff5555; font-weight: bold; margin-top: 20px; 
    background: rgba(0,0,0,0.8); padding: 10px; border-radius: 5px;
    display: none;
  }

  video { display: none; }
</style>

<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.6.0/p5.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
</head>
<body>

<div id="ui-layer">
  <h1>Thumb Baseball</h1>
  <p>スマホ対応・安全版</p>
  
  <div id="buttons">
    <button id="btn-right" class="btn" onclick="tryStart('right')">右手でスタート</button><br>
    <button id="btn-left" class="btn" onclick="tryStart('left')">左手でスタート</button>
  </div>
  
  <div id="loading" style="display:none; color:#0f0; font-size:18px; font-weight:bold;">
    カメラを起動中...<br>そのままお待ちください
  </div>

  <div id="error-msg"></div>
</div>

<video id="input_video" playsinline webkit-playsinline muted autoplay></video>

<script>
let videoElement = document.getElementById('input_video');
let hands;
let isRightHand = true;
let isPlaying = false;
let landmarks = null;

// ゲーム用変数
let handScale = 100;
let smoothedDist = 0;
let batProgress = 0;
let score = 0;
let balls = [];
let panels = [];
let guidePos = {x:0, y:0};

// --- 起動処理 ---
async function tryStart(hand) {
  isRightHand = (hand === 'right');
  
  // 1. UIを「読み込み中」に変更
  document.getElementById('buttons').style.display = 'none';
  document.getElementById('loading').style.display = 'block';
  document.getElementById('error-msg').style.display = 'none';

  // 2. プロトコルチェック (HTTPS必須)
  if (location.protocol !== 'https:' && location.hostname !== 'localhost') {
    showError("【エラー】<br>このページは https:// で開いてください。<br>CodePenなどのWebサービス上でのみ動作します。");
    return;
  }

  // 3. カメラ起動トライ
  try {
    const stream = await navigator.mediaDevices.getUserMedia({
      audio: false,
      video: { facingMode: 'user', width: { ideal: 640 }, height: { ideal: 480 } }
    });
    videoElement.srcObject = stream;
    await videoElement.play();
    
    // 成功したらAIロードへ
    loadAI();
  } catch (err) {
    showError("【カメラエラー】<br>カメラの使用が許可されていません。<br>ブラウザの設定を確認してください。<br>(" + err.name + ")");
  }
}

function loadAI() {
  try {
    hands = new Hands({locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`});
    hands.setOptions({
      maxNumHands: 1,
      modelComplexity: 0, // 軽量モード
      minDetectionConfidence: 0.5,
      minTrackingConfidence: 0.5
    });
    hands.onResults(onResults);
    
    // 準備完了！ UIを消してゲーム開始
    document.getElementById('ui-layer').style.display = 'none';
    isPlaying = true;
    setupGame();
  } catch(e) {
    showError("AI読み込みエラー: " + e);
  }
}

function showError(msg) {
  // エラー時はUIを元に戻してメッセージ表示
  document.getElementById('buttons').style.display = 'block';
  document.getElementById('loading').style.display = 'none';
  const errDiv = document.getElementById('error-msg');
  errDiv.innerHTML = msg;
  errDiv.style.display = 'block';
}

function onResults(results) {
  if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
    landmarks = results.multiHandLandmarks[0];
  } else {
    landmarks = null;
  }
}

// --- p5.js 描画ループ ---
function setup() {
  createCanvas(windowWidth, windowHeight);
  frameRate(30); // スマホ負荷軽減
}

function draw() {
  // 背景 (isPlayingがfalseでも描画されるが、UIの下になる)
  background(30, 100, 30);
  
  if (!isPlaying) return;

  // 1. カメラ映像の描画と送信
  if (videoElement.readyState >= 2) {
    push();
    translate(width, 0); scale(-1, 1);
    
    // アスペクト比維持で画面いっぱいに表示
    let vw = videoElement.videoWidth;
    let vh = videoElement.videoHeight;
    let scaleVal = max(width/vw, height/vh);
    let w = vw * scaleVal;
    let h = vh * scaleVal;
    let x = (width - w) / 2;
    let y = (height - h) / 2;
    
    // 映像描画
    image(videoElement, x, y, w, h);
    
    // AIへ送信
    hands.send({image: videoElement});
    pop();
    
    fill(0, 150); rect(0,0,width,height); // 少し暗くする
  }

  // 2. ゲーム処理
  if (landmarks) {
    // 座標変換
    let idxBase = transform(landmarks[5]);
    let thumbTip = transform(landmarks[4]);
    let wrist = transform(landmarks[0]);

    // 骨格描画
    stroke(0, 255, 255); strokeWeight(2);
    line(idxBase.x, idxBase.y, wrist.x, wrist.y);
    stroke(255, 0, 0); strokeWeight(4);
    line(idxBase.x, idxBase.y, thumbTip.x, thumbTip.y);

    // 操作計算
    let size = dist(idxBase.x, idxBase.y, wrist.x, wrist.y);
    handScale = lerp(handScale, size, 0.1);
    
    let d = dist(idxBase.x, idxBase.y, thumbTip.x, thumbTip.y);
    smoothedDist = lerp(smoothedDist, d, 0.5);

    let val = map(smoothedDist, handScale*0.3, handScale*0.9, 0, 1);
    batProgress = constrain(val, 0, 1);

    drawGuide(true);
  } else {
    drawGuide(false);
  }

  runGameLogic();
  drawHUD();
}

// 座標変換ヘルパー
function transform(lm) {
  return { x: (1-lm.x)*width, y: lm.y*height };
}

function setupGame() {
  updateLayout();
  initPanels();
}

function updateLayout() {
  guidePos = isRightHand ? {x: width*0.85, y: height*0.75} : {x: width*0.15, y: height*0.75};
}

function drawGuide(active) {
  noFill(); stroke(active ? '#0f0' : '#f00'); strokeWeight(3);
  circle(guidePos.x, guidePos.y, 60);
  if(!active) {
    noStroke(); fill(255); textAlign(CENTER); textSize(16);
    text("手を映してください", width/2, height/2);
  }
}

function runGameLogic() {
  // バット
  let bx = isRightHand ? width*0.85 : width*0.15;
  let by = height*0.75 - 60;
  push();
  translate(bx, by);
  let ang = isRightHand ? map(batProgress, 0, 1, PI/4, -PI/4) : map(batProgress, 0, 1, -PI/4, PI/4);
  rotate(ang);
  if(batProgress>0.1) { stroke(0); fill(255,200,0); } else { noStroke(); fill(255,50); }
  rect(-10, 0, 20, 120, 10);
  pop();

  // ボール
  if(frameCount%60===0) balls.push(createBall());
  for(let i=balls.length-1; i>=0; i--) {
    let b = balls[i];
    b.x+=b.vx; b.y+=b.vy;
    fill(b.hit?'#ff0':'#fff'); stroke(0); circle(b.x, b.y, 20);

    // ヒット
    if(!b.hit && batProgress>0.1) {
      if(dist(b.x,b.y,bx,by)<150 && dist(b.x,b.y,guidePos.x,guidePos.y)<150) {
        b.hit=true;
        let tx = isRightHand ? map(batProgress,0.2,0.8,0,width) : map(batProgress,0.2,0.8,width,0);
        let dx=tx-b.x; let dy=(panels[0].y+50)-b.y;
        let len=sqrt(dx*dx+dy*dy);
        b.vx=(dx/len)*25; b.vy=(dy/len)*25;
        score+=10;
      }
    }
    // パネル
    if(b.hit) {
      for(let p of panels) {
        if(p.active && b.x>p.x && b.x<p.x+p.w && b.y>p.y && b.y<p.y+p.h) {
          p.active=false; balls.splice(i,1); return;
        }
      }
    }
    if(b.y>height+50 || b.y<-50) balls.splice(i,1);
  }
  drawPanels();
}

function createBall() {
  let sx = isRightHand ? width*0.1 : width*0.9;
  let tx = guidePos.x; let ty = guidePos.y-50;
  let dx=tx-sx; let dy=ty-height*0.4; let len=sqrt(dx*dx+dy*dy);
  let spd = 8 + score/200;
  return {x:sx, y:height*0.4, vx:(dx/len)*spd, vy:(dy/len)*spd, hit:false};
}

function initPanels() {
  panels=[];
  let w=width/5; let h=height/12;
  for(let i=0; i<3; i++) for(let j=0; j<3; j++) {
    panels.push({
      x: isRightHand ? 20+j*(w+5) : width-(3*(w+5))+j*(w+5),
      y: 50+i*(h+5), w:w, h:h, active:true
    });
  }
}
function drawPanels() {
  if(panels.every(p=>!p.active)) initPanels();
  for(let p of panels) if(p.active) { fill(0,255,0,150); stroke(255); rect(p.x,p.y,p.w,p.h); }
}

function drawHUD() {
  fill(255); textSize(20); textAlign(LEFT,TOP); text("SCORE: "+score, 10,10);
  // ゲージ
  let gh = map(batProgress,0,1,0,100);
  fill(255,0,0); rect(width-30,height-120,20,100);
  fill(0,255,0); rect(width-30,height-120+(100-gh),20,gh);
}

function windowResized(){ resizeCanvas(windowWidth,windowHeight); initPanels(); }
</script>
</body>
</html>
